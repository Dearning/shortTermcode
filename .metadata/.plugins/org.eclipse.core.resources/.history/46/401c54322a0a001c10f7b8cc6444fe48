package cn.edu.zucc.personplan.comtrol.example;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import cn.edu.zucc.personplan.itf.IStepManager;
import cn.edu.zucc.personplan.model.BeanPlan;
import cn.edu.zucc.personplan.model.BeanStep;
import cn.edu.zucc.personplan.model.BeanUser;
import cn.edu.zucc.personplan.util.BaseException;
import cn.edu.zucc.personplan.util.BusinessException;
import cn.edu.zucc.personplan.util.DBUtil;
import cn.edu.zucc.personplan.util.DbException;

public class ExampleStepManager implements IStepManager {

	@Override
	public void add(BeanPlan plan, String name, String planstartdate,
			String planfinishdate) throws BaseException {
		
		
	}

	@Override
	public List<BeanStep> loadSteps(BeanPlan plan) throws BaseException {
		List<BeanStep> result=new ArrayList<BeanStep>();
		BeanStep p=new BeanStep();
		result.add(p);
		return result;
	}

	@Override
	public void deleteStep(BeanStep step) throws BaseException {
		// TODO Auto-generated method stub
		
		Connection connection = null;
		int plan_id=plan.getPlan_id();
		try {
			connection = DBUtil.getConnection();
			String sqlString = "select count(*) from tbl_step where plan_id= " + plan_id;
			Statement statement = connection.createStatement();
			ResultSet resultSet = statement.executeQuery(sqlString);
			//存在步骤,不能删除
			if (resultSet.next()) {
				if (resultSet.getInt(1) > 0) {
					resultSet.close();
					statement.close();
					throw new BusinessException("该计划已经存在步骤,不能删除");
				}
			}
			resultSet.close();
			// 找到
			sqlString = "select plan_order,user_id from tbl_plan where plan_id=" + plan_id;
			resultSet = statement.executeQuery(sqlString);
			int plan_ord = 0;
			String plan_user_id = null;
			if (resultSet.next()) {
				plan_ord = resultSet.getInt(1);
				plan_user_id = resultSet.getString(2);
			} else {
				throw new BusinessException("该计划不存在");
			}
			// 如果必须是自己的计划
			if (!BeanUser.currentLoginUser.getUser_id().equals(plan_user_id)) {
				throw new BusinessException("不能删除别人的计划");
			}
			//
			sqlString = "delete from tbl_plan where plan_id=" + plan_id;
			statement.execute(sqlString);
			//更新比删除序号大的表项
			sqlString = "update tbl_plan set plan_order = plan_order - 1 where user_id=? and plan_order>" + plan_ord;
			PreparedStatement pst = connection.prepareStatement(sqlString);
			pst.setString(1, plan_user_id);
			pst.execute();

			resultSet.close();
			pst.close();
		} catch (Exception e) {
			// TODO: handle exception
			e.printStackTrace();
			throw new DbException(e);
		}finally {
			if(connection!=null) {
				try {
					connection.close();
				} catch (Exception e2) {
					// TODO: handle exception
					e2.printStackTrace();
				}
			}
		}
		
	}

	@Override
	public void startStep(BeanStep step) throws BaseException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void finishStep(BeanStep step) throws BaseException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void moveUp(BeanStep step) throws BaseException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void moveDown(BeanStep step) throws BaseException {
		// TODO Auto-generated method stub
		
	}

}
